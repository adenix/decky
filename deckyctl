#!/bin/bash

# Decky Control Script
# Easy management of Decky Stream Deck service

DECKY_CONFIG_DIR="$HOME/.decky"
SERVICE_NAME="decky"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

usage() {
    cat << EOF
Decky Control - Manage your Stream Deck configuration

Usage: deckyctl [COMMAND] [OPTIONS]

Commands:
    start           Start the Decky service
    stop            Stop the Decky service
    restart         Restart the Decky service
    status          Show service status
    logs            Show service logs (follow mode)
    reload          Reload configuration (same as restart)
    edit [config]   Edit configuration file (default: default.yaml)
    list            List available configurations
    use <config>    Switch to a different configuration
    validate [cfg]  Validate a configuration file
    enable          Enable service to start on login
    disable         Disable service from starting on login

Examples:
    deckyctl start                  # Start the service
    deckyctl edit                   # Edit default config
    deckyctl edit work              # Edit work.yaml config
    deckyctl use kde                # Switch to kde.yaml config
    deckyctl logs                   # View live logs
    deckyctl validate myconfig      # Validate myconfig.yaml

Configuration files are stored in: ~/.decky/configs/
EOF
}

# Ensure config directory exists
ensure_config_dir() {
    if [ ! -d "$DECKY_CONFIG_DIR/configs" ]; then
        echo -e "${YELLOW}Creating configuration directory...${NC}"
        mkdir -p "$DECKY_CONFIG_DIR/configs"
    fi
}

# Main command processing
case "$1" in
    start)
        echo -e "${GREEN}Starting Decky...${NC}"
        systemctl --user start $SERVICE_NAME
        sleep 1
        systemctl --user status $SERVICE_NAME --no-pager -n 5
        ;;

    stop)
        echo -e "${YELLOW}Stopping Decky...${NC}"
        systemctl --user stop $SERVICE_NAME
        echo "Decky stopped."
        ;;

    restart|reload)
        echo -e "${YELLOW}Restarting Decky...${NC}"
        systemctl --user restart $SERVICE_NAME
        sleep 1
        systemctl --user status $SERVICE_NAME --no-pager -n 5
        ;;

    status)
        systemctl --user status $SERVICE_NAME --no-pager
        ;;

    logs)
        echo -e "${GREEN}Showing Decky logs (Ctrl+C to exit)...${NC}"
        journalctl --user -u $SERVICE_NAME -f
        ;;

    edit)
        ensure_config_dir
        CONFIG_NAME="${2:-default}"
        CONFIG_FILE="$DECKY_CONFIG_DIR/configs/${CONFIG_NAME}.yaml"

        if [ ! -f "$CONFIG_FILE" ]; then
            # Remove .yaml extension if user provided it
            CONFIG_NAME="${CONFIG_NAME%.yaml}"
            CONFIG_FILE="$DECKY_CONFIG_DIR/configs/${CONFIG_NAME}.yaml"
        fi

        if [ ! -f "$CONFIG_FILE" ]; then
            echo -e "${YELLOW}Config file not found: $CONFIG_FILE${NC}"
            echo "Available configs:"
            ls -1 "$DECKY_CONFIG_DIR/configs/"*.yaml 2>/dev/null | xargs -n1 basename | sed 's/\.yaml$//'
            exit 1
        fi

        ${EDITOR:-nano} "$CONFIG_FILE"

        echo -e "${GREEN}Configuration edited.${NC}"
        read -p "Restart Decky to apply changes? [Y/n] " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Nn]$ ]]; then
            systemctl --user restart $SERVICE_NAME
            echo -e "${GREEN}Decky restarted with new configuration.${NC}"
        fi
        ;;

    list)
        ensure_config_dir
        echo -e "${GREEN}Available configurations:${NC}"
        echo "Location: $DECKY_CONFIG_DIR/configs/"
        echo

        # Get current config from service file
        CURRENT=$(grep -oP '(?<=configs/)[^.]+(?=\.yaml)' ~/.config/systemd/user/decky.service 2>/dev/null || echo "default")

        for config in "$DECKY_CONFIG_DIR/configs/"*.yaml; do
            if [ -f "$config" ]; then
                name=$(basename "$config" .yaml)
                if [ "$name" = "$CURRENT" ]; then
                    echo -e "  ${GREEN}● $name${NC} (active)"
                else
                    echo "  ○ $name"
                fi
            fi
        done
        ;;

    use)
        if [ -z "$2" ]; then
            echo -e "${RED}Error: Please specify a configuration name${NC}"
            echo "Usage: deckyctl use <config-name>"
            exit 1
        fi

        ensure_config_dir
        CONFIG_NAME="${2%.yaml}"  # Remove .yaml if provided
        CONFIG_FILE="$DECKY_CONFIG_DIR/configs/${CONFIG_NAME}.yaml"

        if [ ! -f "$CONFIG_FILE" ]; then
            echo -e "${RED}Error: Configuration not found: $CONFIG_FILE${NC}"
            echo "Available configs:"
            ls -1 "$DECKY_CONFIG_DIR/configs/"*.yaml 2>/dev/null | xargs -n1 basename | sed 's/\.yaml$//'
            exit 1
        fi

        # Update the service file
        echo -e "${YELLOW}Switching to configuration: ${CONFIG_NAME}${NC}"
        sed -i "s|%h/.decky/configs/[^.]*\.yaml|%h/.decky/configs/${CONFIG_NAME}.yaml|" ~/.config/systemd/user/decky.service

        systemctl --user daemon-reload
        systemctl --user restart $SERVICE_NAME

        echo -e "${GREEN}Switched to configuration: ${CONFIG_NAME}${NC}"
        ;;

    validate)
        CONFIG_NAME="${2:-default}"
        CONFIG_FILE="$DECKY_CONFIG_DIR/configs/${CONFIG_NAME}.yaml"

        if [ ! -f "$CONFIG_FILE" ]; then
            CONFIG_NAME="${CONFIG_NAME%.yaml}"
            CONFIG_FILE="$DECKY_CONFIG_DIR/configs/${CONFIG_NAME}.yaml"
        fi

        if [ ! -f "$CONFIG_FILE" ]; then
            echo -e "${RED}Error: Configuration not found: $CONFIG_FILE${NC}"
            exit 1
        fi

        # Find the Decky installation directory
        DECKY_DIR="$(dirname "$(readlink -f "$0")")"

        if [ -f "$DECKY_DIR/.venv/bin/python" ]; then
            "$DECKY_DIR/.venv/bin/python" "$DECKY_DIR/src/validate.py" "$CONFIG_FILE"
        else
            echo -e "${RED}Error: Cannot find Decky installation${NC}"
            exit 1
        fi
        ;;

    enable)
        echo -e "${GREEN}Enabling Decky service...${NC}"
        systemctl --user enable $SERVICE_NAME
        echo "Decky will start automatically on login."
        ;;

    disable)
        echo -e "${YELLOW}Disabling Decky service...${NC}"
        systemctl --user disable $SERVICE_NAME
        echo "Decky will not start automatically on login."
        ;;

    *)
        usage
        exit 0
        ;;
esac